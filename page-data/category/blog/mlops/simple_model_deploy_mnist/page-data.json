{"componentChunkName":"component---src-templates-post-tsx","path":"/category/blog/mlops/simple_model_deploy_mnist/","result":{"data":{"site":{"siteMetadata":{"title":"어서OpShow","author":"장수완","siteUrl":"https://ssuwani.github.io"}},"markdownRemark":{"id":"f7832544-1e6e-554b-98c4-afa4344adc0e","excerpt":"간단한 코드로 Vertex AI에서 모델 학습 및 배포하는 과정을 다룬다. MNIST 데이터는 데이터를 불러오는 과정을 간단하게 로 할 수 있기 때문에 아래와 같이 간단히 2개의 컴포넌트로 구성할 수 있다. Load data & Training Deploy with endpoint…","html":"<blockquote>\n<p>간단한 코드로 Vertex AI에서 모델 학습 및 배포하는 과정을 다룬다.</p>\n</blockquote>\n<p>MNIST 데이터는 데이터를 불러오는 과정을 간단하게 <code class=\"language-text\">load_data</code>로 할 수 있기 때문에 아래와 같이 간단히 2개의 컴포넌트로 구성할 수 있다.</p>\n<ul>\n<li>Load data &#x26; Training</li>\n<li>Deploy with endpoint</li>\n</ul>\n<p>아래의 과정을 따라오면 다음과 같은 파이프라인을 설계할 수 있다.</p>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 716px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/8ceb8ea31754ae3312b62dd43d5264ca/6bbf7/simple_pipeline.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 108.51063829787235%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAABYlAAAWJQFJUiTwAAAC2ElEQVQ4y5VVy1LbQBD0p+eaPyCXHHNJ5ZBbciI5UORCUSkIgRiMbfzAb0mrfa/UzKyQLMcuElQ1pd3Vera3e3rcKYoCdTjnAVCUHs57lGUZg5/6XT885/3GWUirYL2DNAqdOlkIBcpg8f1a43rqEZxGfzCkGKDbvcV4PMF9v4/efR83f7qYTh+bA88ml/h09QWrfLNN6EMACoujbxLH14zS4aZ7h8FwRPEAmWfIhEAuMiTJBmmaNmiP+z/w9uQdEpVtE3IopeCshncmjkWeQ9JbKoP7uUUgGgYLB2U8PF3RGINcSUySGabpHPN0uZvQORcTqCY0jFbYZArDuYQljsZLicVGQmsJKdt7GYxDJ9BV20lrXjjqudD8jUUpWQ1kPOc9B/bvJWyLVNA35wusc14LlXD0FtJFhau13d93DiVrJ7U6g5UTWGsjSqZlLC02uuL079+8mJDRWbUC8gvizMY1S0KcpwYDoVG46pBXIKTr5RLzdRZJZ5601rF0cioh91qEsT59wEq4KMB2zcfDAnN4KGFZi9BCFsehIl2asFW9pWw1344blZlo9nAILiLipyoZ4jGU+D1xJICDdS7u5VBGQ1sDw0FGqG/QiRVPCp7eGqxlQRYTuOv1yKtTPM5muL3rYTxbN4fUqCwdfvpwjpPhGVIp6DZFpIAQerKPxZvPAr8mrGqGn5dXsQlwwuViRspqHHren3/E0dmHiLamqcMEs8Xq6/A4f7aUoIOWedWmRisT/cv16GmeKYFR8hhjLZKIuhEllgI1ghiSg7xKpp8uBXpTQZ7NcTMSSDPR7OPGIah0OPiQxnpb/2LHl7yQqlD5N/JHnjZF01zb+3ZU3ivmZ3WNoyagykY9T6Qnsvq2V17/KmyuSUXiGLl4bgJFvJZWaSyTds3uJdxrX0WFzssRIC6gdOUKTSJg9ZUOWUeP/zfC+OdDygtRtXwWjNdYmIw6M/v4JYRPnBuxiueHkT4AAAAASUVORK5CYII=&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"simple pipeline\" title=\"simple pipeline\" src=\"/static/8ceb8ea31754ae3312b62dd43d5264ca/6bbf7/simple_pipeline.png\" srcset=\"/static/8ceb8ea31754ae3312b62dd43d5264ca/4dcb9/simple_pipeline.png 188w,\n/static/8ceb8ea31754ae3312b62dd43d5264ca/5ff7e/simple_pipeline.png 375w,\n/static/8ceb8ea31754ae3312b62dd43d5264ca/6bbf7/simple_pipeline.png 716w\" sizes=\"(max-width: 716px) 100vw, 716px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n  </a>\n    </span>\n<h2 id=\"0-import-library\" style=\"position:relative;\"><a href=\"#0-import-library\" aria-label=\"0 import library permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>0. Import Library</h2>\n<p>Library를 불러오는 부분이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-python line-numbers\"><code class=\"language-python\"><span class=\"token keyword\">import</span> kfp\n<span class=\"token keyword\">from</span> kfp <span class=\"token keyword\">import</span> dsl\n<span class=\"token keyword\">from</span> kfp<span class=\"token punctuation\">.</span>v2 <span class=\"token keyword\">import</span> compiler\n<span class=\"token keyword\">from</span> kfp<span class=\"token punctuation\">.</span>v2<span class=\"token punctuation\">.</span>dsl <span class=\"token keyword\">import</span> <span class=\"token punctuation\">(</span>Artifact<span class=\"token punctuation\">,</span> Dataset<span class=\"token punctuation\">,</span> Input<span class=\"token punctuation\">,</span> InputPath<span class=\"token punctuation\">,</span> Model<span class=\"token punctuation\">,</span> Output<span class=\"token punctuation\">,</span>\n                        OutputPath<span class=\"token punctuation\">,</span> ClassificationMetrics<span class=\"token punctuation\">,</span> Metrics<span class=\"token punctuation\">,</span> component<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">from</span> google<span class=\"token punctuation\">.</span>cloud<span class=\"token punctuation\">.</span>aiplatform <span class=\"token keyword\">import</span> pipeline_jobs\n\n<span class=\"token keyword\">from</span> datetime <span class=\"token keyword\">import</span> datetime</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id=\"1-load-data--training-component\" style=\"position:relative;\"><a href=\"#1-load-data--training-component\" aria-label=\"1 load data  training component permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. Load data &#x26; Training Component</h2>\n<p>데이터를 불러와서 전처리 한 뒤 모델을 정의하고 학습을 진행할 것이다. 사실 각각의 컴포넌트로 구현을 하는 것이 옳을지 모르겠다. 간단하게 배포를 위한 포스팅이니 하나의 컴포넌트로 구성했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-python line-numbers\"><code class=\"language-python\"><span class=\"token decorator annotation punctuation\">@component</span><span class=\"token punctuation\">(</span>\n    packages_to_install<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"tensorflow\"</span><span class=\"token punctuation\">]</span> <span class=\"token comment\"># 1</span>\n<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">load_data_and_training</span><span class=\"token punctuation\">(</span>\n    output_model<span class=\"token punctuation\">:</span> Output<span class=\"token punctuation\">[</span>Model<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token comment\"># 2</span>\n    metrics<span class=\"token punctuation\">:</span> Output<span class=\"token punctuation\">[</span>Metrics<span class=\"token punctuation\">]</span> <span class=\"token comment\"># 3</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">import</span> tensorflow <span class=\"token keyword\">as</span> tf\n    \n    mnist <span class=\"token operator\">=</span> tf<span class=\"token punctuation\">.</span>keras<span class=\"token punctuation\">.</span>datasets<span class=\"token punctuation\">.</span>mnist <span class=\"token comment\"># 4</span>\n    <span class=\"token punctuation\">(</span>train_x<span class=\"token punctuation\">,</span> train_y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>test_x<span class=\"token punctuation\">,</span> test_y<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> mnist<span class=\"token punctuation\">.</span>load_data<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    train_x <span class=\"token operator\">=</span> train_x <span class=\"token operator\">/</span> <span class=\"token number\">255.0</span>\n    test_x <span class=\"token operator\">=</span> test_x <span class=\"token operator\">/</span> <span class=\"token number\">255.0</span>\n    \n    model <span class=\"token operator\">=</span> tf<span class=\"token punctuation\">.</span>keras<span class=\"token punctuation\">.</span>Sequential<span class=\"token punctuation\">(</span> <span class=\"token comment\"># 5</span>\n        <span class=\"token punctuation\">[</span>\n            tf<span class=\"token punctuation\">.</span>keras<span class=\"token punctuation\">.</span>layers<span class=\"token punctuation\">.</span>Flatten<span class=\"token punctuation\">(</span>input_shape<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">28</span><span class=\"token punctuation\">,</span> <span class=\"token number\">28</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            tf<span class=\"token punctuation\">.</span>keras<span class=\"token punctuation\">.</span>layers<span class=\"token punctuation\">.</span>Dense<span class=\"token punctuation\">(</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span> activation<span class=\"token operator\">=</span><span class=\"token string\">'relu'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            tf<span class=\"token punctuation\">.</span>keras<span class=\"token punctuation\">.</span>layers<span class=\"token punctuation\">.</span>Dense<span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span> activation<span class=\"token operator\">=</span><span class=\"token string\">'softmax'</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">)</span>\n    model<span class=\"token punctuation\">.</span><span class=\"token builtin\">compile</span><span class=\"token punctuation\">(</span> <span class=\"token comment\"># 6</span>\n        optimizer<span class=\"token operator\">=</span><span class=\"token string\">'adam'</span><span class=\"token punctuation\">,</span>\n        loss<span class=\"token operator\">=</span><span class=\"token string\">'sparse_categorical_crossentropy'</span><span class=\"token punctuation\">,</span>\n        metrics<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">'accuracy'</span><span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">)</span>\n    model<span class=\"token punctuation\">.</span>fit<span class=\"token punctuation\">(</span>train_x<span class=\"token punctuation\">,</span> train_y<span class=\"token punctuation\">,</span> epochs<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># 7</span>\n    loss<span class=\"token punctuation\">,</span> acc <span class=\"token operator\">=</span> model<span class=\"token punctuation\">.</span>evaluate<span class=\"token punctuation\">(</span>test_x<span class=\"token punctuation\">,</span> test_y<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 8</span>\n    \n    metrics<span class=\"token punctuation\">.</span>log_metric<span class=\"token punctuation\">(</span><span class=\"token string\">\"acc\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>acc<span class=\"token operator\">*</span><span class=\"token number\">100.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># 9</span>\n    metrics<span class=\"token punctuation\">.</span>log_metric<span class=\"token punctuation\">(</span><span class=\"token string\">\"loss\"</span><span class=\"token punctuation\">,</span> loss<span class=\"token punctuation\">)</span>\n    metrics<span class=\"token punctuation\">.</span>log_metric<span class=\"token punctuation\">(</span><span class=\"token string\">\"Model\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"LinearModel\"</span><span class=\"token punctuation\">)</span>\n    metrics<span class=\"token punctuation\">.</span>log_metric<span class=\"token punctuation\">(</span><span class=\"token string\">\"dataset size\"</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>train_x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    \n    model<span class=\"token punctuation\">.</span>save<span class=\"token punctuation\">(</span>output_model<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 10</span>\n\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"Model saved path : </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>output_model<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"Model saved uri : </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>output_model<span class=\"token punctuation\">.</span>uri<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>코드 옆에 주석으로 숫자를 표시해두었다. 간단하게 설명을 적어두려 한다.</p>\n<ul>\n<li>\n<p>1: <code class=\"language-text\">kip.v2.dsl</code> 에 정의된 <code class=\"language-text\">component</code>  데코레이터이다. 일반 함수를 파이프라인 컴포넌트로 변경해준다. 3개의 argument를 사용할 수 있다.</p>\n<ul>\n<li><code class=\"language-text\">base_image</code> : 지정해주지 않으면 기본적으로 python:3.7 이미지를 사용한다.</li>\n<li><code class=\"language-text\">output_component_file</code> : component에 정의된 내용을 <code class=\"language-text\">yaml</code> 파일로 작성하여 협업을 위해 사용하거나 다른 파이프라인에서 사용할 수 있다.</li>\n<li><code class=\"language-text\">packages_to_install</code>: base_image에서 추가적으로 패키지를 설치할 때 사용한다. 패키지 리스트를 입력해주면 된다. 나의 경우 python:3.7 이미지에 tensorflow를 설치했다.</li>\n</ul>\n</li>\n<li>2: Ouput은 컴포넌트의 출력을 정의할 수 있다. 훈련한 모델을 저장하기 위한 경로를 Deploy Component에서 사용하기 위해 출력했다.</li>\n<li>3: Metrics은 위와같이 <code class=\"language-text\">log_metric</code> 으로 값을 주면 Vertex AI Pipeline의 “실행 측정항목” 에서 확인할 수 있을 뿐만 아니라 여러개의 파이프라인을 선택하여 Metrics에 입력한 값을 기반으로 서로 비교할 수 있다.</li>\n<li>4: MNIST 데이터셋의 불러오고 전처리를 하는 과정이다.</li>\n<li>5: Tensorflow로 간단한 Linear Model을 정의하는 부분이다.</li>\n<li>6: 모델 학습과정을 정의하는 compile 부분이다.</li>\n<li>7: 모델 학습</li>\n<li>8: 모델 평가, 기본적으로 loss를 반환하고 <code class=\"language-text\">compile</code> 시 <code class=\"language-text\">metrics</code> 로 지정했던 측정항목들이 순서대로 출력된다.</li>\n<li>9: 3번에서 이야기했던 Component mertric을 지정하는 부분이다. key value의 쌍으로 값을 준다.</li>\n<li>10: 모델을 저장하는 부분이다. Output으로 지정했던 output_model의 path에 모델을 저장한다</li>\n</ul>\n<p>Metrics의 <code class=\"language-text\">log_metric</code> 으로 지정한 뒤 학습의 결과는 다음과 같이 확인할 수 있다.</p>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/66509c4bbe52396f3622a91b3810bf09/f79fa/metrics.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 36.17021276595745%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAAAvElEQVQoz42R2wqEMBBD/f/fkyo+9aVoFS+oaL1nyUDFBVe3EDo+THIagyzLEMcxlFIIwxB35ziOvxUMw4CqqlCWJay1MjdNI6rrWr6vxm8nGMdRlqZpwrqumOdZtCwLnHPo+17ubdtO033fbyWEaZoiSZKvBU/CMFZijEHXdWLM0EdD/1wuc8ET8GYdRVEIJWfWQMNflGKY5zmiKILW+uzL07ZtK4QMolgFq3kl9EbXZM404Y/xIiFDngg/es0hdD4v0M4AAAAASUVORK5CYII=&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"metrics\" title=\"metrics\" src=\"/static/66509c4bbe52396f3622a91b3810bf09/1d69c/metrics.png\" srcset=\"/static/66509c4bbe52396f3622a91b3810bf09/4dcb9/metrics.png 188w,\n/static/66509c4bbe52396f3622a91b3810bf09/5ff7e/metrics.png 375w,\n/static/66509c4bbe52396f3622a91b3810bf09/1d69c/metrics.png 750w,\n/static/66509c4bbe52396f3622a91b3810bf09/f79fa/metrics.png 940w\" sizes=\"(max-width: 750px) 100vw, 750px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n  </a>\n    </span>\n<p>CNN 모델을 하나 더 만들어서 간단하게 비교해보았다. 참고로만 보자.</p>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/4de6fc824e7842db7b8dc9c69e705dd1/b8bf8/compare.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 14.361702127659576%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAcElEQVQI102NWQpEIQwE3/0vqh/ivm8ZukEYoUhMZfmcc4K395ZzDuNai7wc9efmnOT5/xnEz3svIIQgWJ5zllqrKKUY4YwxjHBaa0kpsddaSzA7xiAfxAONAAL/Uoq01pjHGKX3Tn/v5TEse4dQAz+29ehXBcTD+gAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"compare\" title=\"compare\" src=\"/static/4de6fc824e7842db7b8dc9c69e705dd1/1d69c/compare.png\" srcset=\"/static/4de6fc824e7842db7b8dc9c69e705dd1/4dcb9/compare.png 188w,\n/static/4de6fc824e7842db7b8dc9c69e705dd1/5ff7e/compare.png 375w,\n/static/4de6fc824e7842db7b8dc9c69e705dd1/1d69c/compare.png 750w,\n/static/4de6fc824e7842db7b8dc9c69e705dd1/78797/compare.png 1125w,\n/static/4de6fc824e7842db7b8dc9c69e705dd1/aa440/compare.png 1500w,\n/static/4de6fc824e7842db7b8dc9c69e705dd1/b8bf8/compare.png 1728w\" sizes=\"(max-width: 750px) 100vw, 750px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n  </a>\n    </span>\n<h2 id=\"2-deploy-with-endpoint\" style=\"position:relative;\"><a href=\"#2-deploy-with-endpoint\" aria-label=\"2 deploy with endpoint permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Deploy with endpoint</h2>\n<p>앞서 저장한 모델을 서빙하는 부분이다. 모델을 배포하고 endpoint를 생성하여 연결한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-python line-numbers\"><code class=\"language-python\"><span class=\"token decorator annotation punctuation\">@component</span><span class=\"token punctuation\">(</span>\n    packages_to_install<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"google-cloud-aiplatform\"</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">deploy_model</span><span class=\"token punctuation\">(</span>\n    model<span class=\"token punctuation\">:</span> Input<span class=\"token punctuation\">[</span>Model<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    project<span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">,</span>\n    region<span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">,</span>\n    vertex_endpoint<span class=\"token punctuation\">:</span> Output<span class=\"token punctuation\">[</span>Artifact<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    vertex_model<span class=\"token punctuation\">:</span> Output<span class=\"token punctuation\">[</span>Model<span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">from</span> google<span class=\"token punctuation\">.</span>cloud <span class=\"token keyword\">import</span> aiplatform\n\n    aiplatform<span class=\"token punctuation\">.</span>init<span class=\"token punctuation\">(</span>project<span class=\"token operator\">=</span>project<span class=\"token punctuation\">,</span> location<span class=\"token operator\">=</span>region<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 1</span>\n\n    deployed_model <span class=\"token operator\">=</span> aiplatform<span class=\"token punctuation\">.</span>Model<span class=\"token punctuation\">.</span>upload<span class=\"token punctuation\">(</span> <span class=\"token comment\"># 2</span>\n        display_name<span class=\"token operator\">=</span><span class=\"token string\">\"simple-mnist-pipeline\"</span><span class=\"token punctuation\">,</span>\n        artifact_uri <span class=\"token operator\">=</span> model<span class=\"token punctuation\">.</span>uri<span class=\"token punctuation\">,</span>\n        serving_container_image_uri<span class=\"token operator\">=</span><span class=\"token string\">\"us-docker.pkg.dev/vertex-ai/prediction/tf2-cpu.2-6:latest\"</span>\n    <span class=\"token punctuation\">)</span>\n    endpoint <span class=\"token operator\">=</span> deployed_model<span class=\"token punctuation\">.</span>deploy<span class=\"token punctuation\">(</span>machine_type<span class=\"token operator\">=</span><span class=\"token string\">\"n1-standard-4\"</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># 3</span>\n\n    <span class=\"token comment\"># Save data to the output params</span>\n    vertex_endpoint<span class=\"token punctuation\">.</span>uri <span class=\"token operator\">=</span> endpoint<span class=\"token punctuation\">.</span>resource_name <span class=\"token comment\"># 4</span>\n    vertex_model<span class=\"token punctuation\">.</span>uri <span class=\"token operator\">=</span> deployed_model<span class=\"token punctuation\">.</span>resource_name </code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<ul>\n<li>1: 모델을 업로드하는 과정은 google cloud의 서비스에 종속적이다.</li>\n<li>2: 모델 서빙을 위해서 저장한 모델을 불러와서 Vertex ai에서 관리하는 모델로 등록한다. 이때 어떠한 이미지를 기반으로 serving 모델을 만들지 <code class=\"language-text\">serving_container_image_uri</code> 로 지정해줘야 한다.  <a href=\"https://console.cloud.google.com/artifacts/docker/vertex-ai/us/prediction\">여기</a>에 들어가면 Prediction을 위한 다양한 베이스 이미지를 확인할 수 있다.</li>\n<li>3: 2에서 업로드한 모델을 endpoint와 연결짓는 부분이다. endpoint를 인자로 주지 않으면 disploy<em>name의 이름으로 자동으로 생성된다. 여기서 배포를 위한 replicas, accelartor 그리고 하나의 엔드포인트에 여러개의 모델이 연결될 수 있으므로 traffic</em>percentage 등도 설정이 가능하다. <a href=\"https://googleapis.dev/python/aiplatform/latest/aiplatform.html#google.cloud.aiplatform.Model.deploy\">여기</a>를 참고하자.</li>\n<li>4: component의 Output으로 지정한 <code class=\"language-text\">vertex_endpoint</code> , <code class=\"language-text\">vertex_model</code> 이 처음으로 등장했는데, 단순히 컴포넌트의 결과로서 배포된 모델의 정보와 Endpoint의 정보를 확인하기 위함이다. 사실 꼭 필요한 부분은 아니다. </li>\n</ul>\n<p>4번과 같이 Ouput을 지정해주면 아래의 사진과 같이 Pipeline에서 정보들을 출력해준다.</p>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/a2b0df0382defecad4b0c7697ebf3477/ea64c/outputs.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 36.17021276595745%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABO0lEQVQoz42QyXLCMBBE+f8/yDXfkVMO5ALZWArMGhsIWfCKbMmS9SKZCiSHVOXQ1apRT0/PdJqmwcM4YBuOpeZpWTGJJMNVwXh9pDfNGKwrZltFsFEMw4K72Qf7ROGaMObk4dH5ZUhDIWqubwWPK8VgHPIw2jAM9uw+Fe9pQ5zBcLfnqnvD4rX6n2E/OPK8dMmCgtFauFSSSSjatPdzQX+e0J2+sTv8aWjPBetQSk0uNFJpVH3h73dRGncag7UXo7OhMQZdK7TWrmAQ0nAodJvW/xnj6o5PW9Ay1pC5W2duqHU9vtfD6ztKW2y5xMgD0eaVMNqwfgkRZQntQlDXtYMzznrUVUK03ROGEcF8wSGOW50f5HUdL5RlgqwESZo5pMRJSureSimklC17cZWHVGVOmuWtxms9fuq+AMNCGfWgKfgfAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"outputs\" title=\"outputs\" src=\"/static/a2b0df0382defecad4b0c7697ebf3477/1d69c/outputs.png\" srcset=\"/static/a2b0df0382defecad4b0c7697ebf3477/4dcb9/outputs.png 188w,\n/static/a2b0df0382defecad4b0c7697ebf3477/5ff7e/outputs.png 375w,\n/static/a2b0df0382defecad4b0c7697ebf3477/1d69c/outputs.png 750w,\n/static/a2b0df0382defecad4b0c7697ebf3477/ea64c/outputs.png 1116w\" sizes=\"(max-width: 750px) 100vw, 750px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n  </a>\n    </span>\n<p>그리고 각 아티팩트의 세부정보를 확인해보면 uri를 확인할 수 있다.</p>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/a3a76542555b67e7da698e910876ee32/5f652/artifacts.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 28.191489361702125%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAp0lEQVQY06WQ2Q7CIBBF+f9vtLXSF7GlC1ipZeAWptUXjUkjycllmTmZIM5lgVpKPJxDXjHGvxDzEuEpbjLgQ3p0CdU53KeZdd8khyecJsuyEAJfEBGstYzbvyHE/Bbe+VOotd6adqH3Hm3TQl0Vhn5ESN9BnlIGruHcoYx/QYwwxrAwT5YblqeHOnVoqh7tZUBTDilHpqsNtDSc+awzctvfilRXjVgBhZPWiFI2OEIAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"artifacts\" title=\"artifacts\" src=\"/static/a3a76542555b67e7da698e910876ee32/1d69c/artifacts.png\" srcset=\"/static/a3a76542555b67e7da698e910876ee32/4dcb9/artifacts.png 188w,\n/static/a3a76542555b67e7da698e910876ee32/5ff7e/artifacts.png 375w,\n/static/a3a76542555b67e7da698e910876ee32/1d69c/artifacts.png 750w,\n/static/a3a76542555b67e7da698e910876ee32/78797/artifacts.png 1125w,\n/static/a3a76542555b67e7da698e910876ee32/5f652/artifacts.png 1302w\" sizes=\"(max-width: 750px) 100vw, 750px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n  </a>\n    </span>\n<h2 id=\"3-define-pipeline\" style=\"position:relative;\"><a href=\"#3-define-pipeline\" aria-label=\"3 define pipeline permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. Define Pipeline</h2>\n<p>위에서 정의한 두개의 컴포넌트를 실행하는 Pipeline을 작성한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-python line-numbers\"><code class=\"language-python\"><span class=\"token decorator annotation punctuation\">@dsl<span class=\"token punctuation\">.</span>pipeline</span><span class=\"token punctuation\">(</span>\n    pipeline_root<span class=\"token operator\">=</span>PIPELINE_ROOT<span class=\"token punctuation\">,</span> <span class=\"token comment\"># 1</span>\n    name<span class=\"token operator\">=</span><span class=\"token string\">\"simple-mnist-pipeline\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">pipeline</span><span class=\"token punctuation\">(</span>\n    project<span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span> <span class=\"token operator\">=</span> PROJECT_ID<span class=\"token punctuation\">,</span> <span class=\"token comment\"># 2</span>\n    region<span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span> <span class=\"token operator\">=</span> REGION\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    load_data_and_training_task <span class=\"token operator\">=</span> load_data_and_training<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># 3</span>\n\n    deploy_task <span class=\"token operator\">=</span> deploy_model<span class=\"token punctuation\">(</span> <span class=\"token comment\"># 4</span>\n        model<span class=\"token operator\">=</span>load_data_and_training_task<span class=\"token punctuation\">.</span>outputs<span class=\"token punctuation\">[</span><span class=\"token string\">\"output_model\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        project<span class=\"token operator\">=</span>project<span class=\"token punctuation\">,</span>\n        region<span class=\"token operator\">=</span>region\n    <span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<ul>\n<li>1: 파이프라인을 실행하면서 생성될 Artifacts를 저장하기 위한 중간 저장소이다. MinIO, S3, GCS 등을 사용할 수 있다.</li>\n<li>2: 앞서 설명했다시피 <code class=\"language-text\">deploy_model</code> 의 경우 google cloud에 종속적이다. 파라미터로 값을 받아 deploy를 위해 사용한다.</li>\n<li>3: 처음으로 정의한 Load data &#x26; Training Component 를 실행하는 부분이다.</li>\n<li>4: 두번째로 정의한 Deploy with endpoint 를 실행하는 부분이다. load<em>data</em>and<em>training</em>task의 ouput 중 output_model를 불러와 입력으로 사용한다.</li>\n</ul>\n<h2 id=\"4-run-pipeline\" style=\"position:relative;\"><a href=\"#4-run-pipeline\" aria-label=\"4 run pipeline permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. Run Pipeline</h2>\n<p>정의한 파이프라인을 Vertex AI에서 실행하는 부분이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-python line-numbers\"><code class=\"language-python\">TIMESTAMP <span class=\"token operator\">=</span> datetime<span class=\"token punctuation\">.</span>now<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>strftime<span class=\"token punctuation\">(</span><span class=\"token string\">\"%Y%m%d%H%M%S\"</span><span class=\"token punctuation\">)</span>\n\ncompiler<span class=\"token punctuation\">.</span>Compiler<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">compile</span><span class=\"token punctuation\">(</span>\n    pipeline_func<span class=\"token operator\">=</span>pipeline<span class=\"token punctuation\">,</span> package_path<span class=\"token operator\">=</span><span class=\"token string\">\"simple_mnist_pipeline.json\"</span>\n<span class=\"token punctuation\">)</span>\n\nrun <span class=\"token operator\">=</span> pipeline_jobs<span class=\"token punctuation\">.</span>PipelineJob<span class=\"token punctuation\">(</span>\n    display_name<span class=\"token operator\">=</span><span class=\"token string\">\"simple-mnist-pipeline\"</span><span class=\"token punctuation\">,</span>\n    template_path<span class=\"token operator\">=</span><span class=\"token string\">\"simple_mnist_pipeline.json\"</span><span class=\"token punctuation\">,</span>\n    job_id<span class=\"token operator\">=</span><span class=\"token string\">\"simple-mnist-pipeline-{0}\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>TIMESTAMP<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    parameter_values<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    enable_caching<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span>\n\nrun<span class=\"token punctuation\">.</span>run<span class=\"token punctuation\">(</span>sync<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>","tableOfContents":"<ul>\n<li><a href=\"/category/blog/mlops/simple_model_deploy_mnist/#0-import-library\">0. Import Library</a></li>\n<li><a href=\"/category/blog/mlops/simple_model_deploy_mnist/#1-load-data--training-component\">1. Load data &#x26; Training Component</a></li>\n<li><a href=\"/category/blog/mlops/simple_model_deploy_mnist/#2-deploy-with-endpoint\">2. Deploy with endpoint</a></li>\n<li><a href=\"/category/blog/mlops/simple_model_deploy_mnist/#3-define-pipeline\">3. Define Pipeline</a></li>\n<li><a href=\"/category/blog/mlops/simple_model_deploy_mnist/#4-run-pipeline\">4. Run Pipeline</a></li>\n</ul>","frontmatter":{"title":"[MLOps] Vertex AI에서 모델 배포하기 (MNIST)","description":"","date":"2021.11.01","emoji":"🏃","category":"blog"}}},"pageContext":{"slug":"/category/blog/mlops/simple_model_deploy_mnist/","relatedPosts":[{"node":{"fields":{"slug":"/category/blog/interview/"},"frontmatter":{"title":"[면접준비] minimum 질문&답변","date":"2021.11.22","emoji":"❓","category":"blog"}}},{"node":{"fields":{"slug":"/category/blog/hackerrank_certification/"},"frontmatter":{"title":"해커랭크 인증서 발급 후기","date":"2021.11.19","emoji":"📚","category":"blog"}}},{"node":{"fields":{"slug":"/category/blog/m1-tensorflow/"},"frontmatter":{"title":"[Tensorflow] M1에서 Tensorflow GPU 사용하기 (Monterey)","date":"2021.11.13","emoji":"💪","category":"blog"}}},{"node":{"fields":{"slug":"/category/blog/effective-python/"},"frontmatter":{"title":"[책] 파이썬 코딩의 기술","date":"2021.11.02","emoji":"📚","category":"blog"}}}]}}}