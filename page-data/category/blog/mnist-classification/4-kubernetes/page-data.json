{"componentChunkName":"component---src-templates-post-tsx","path":"/category/blog/mnist-classification/4-kubernetes/","result":{"data":{"site":{"siteMetadata":{"title":"어서OpShow","author":"장수완","siteUrl":"https://ssuwani.github.io"}},"markdownRemark":{"id":"739edd86-d36b-5986-94b6-a4d8e92b99ab","excerpt":"Kubernetes 위에 올려보자 실험 날짜: 2021년 10월 12일\n실험자: Suwan Jang 앞서 도커로 MNIST 분류 서비스를 위한 각 Task…","html":"<h1 id=\"kubernetes-위에-올려보자\" style=\"position:relative;\"><a href=\"#kubernetes-%EC%9C%84%EC%97%90-%EC%98%AC%EB%A0%A4%EB%B3%B4%EC%9E%90\" aria-label=\"kubernetes 위에 올려보자 permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Kubernetes 위에 올려보자</h1>\n<p>실험 날짜: 2021년 10월 12일\n실험자: Suwan Jang</p>\n<p>앞서 도커로 MNIST 분류 서비스를 위한 각 Task를 이미지로 만들었다. 또한 컨테이너간 데이터 저장을 위해 도커 볼륨도 하나 만들었다.</p>\n<p>이제 이를 쿠버네티스 위에서 올려서 조금 더 유연하게 관리해보자.</p>\n<h3 id=\"-stack\" style=\"position:relative;\"><a href=\"#-stack\" aria-label=\" stack permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>📚 Stack</h3>\n<ul>\n<li>Kubernetes</li>\n<li>Network</li>\n</ul>\n<p>✅ <strong>TODO</strong></p>\n<ul>\n<li class=\"task-list-item\"><input type=\"checkbox\" checked disabled>  PV &#x26; PVC</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" checked disabled>  MNIST Train &#x26; Save Model in PVC</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" checked disabled>  MNIST Serving</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" checked disabled>  Run React App</li>\n</ul>\n<h4 id=\"✓-pv--pvc\" style=\"position:relative;\"><a href=\"#%E2%9C%93-pv--pvc\" aria-label=\"✓ pv  pvc permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><strong>✓ PV &#x26; PVC</strong></h4>\n<p>hostPath PV를 생성한다. 이는 단일노드에서만 지원된다. </p>\n<p>minikube ssh를 통해 클러스터 노드의 셸에 접속해 연결을 위한 디렉토리를 하나 생성하자</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">minikube <span class=\"token function\">ssh</span>\n<span class=\"token function\">sudo</span> <span class=\"token function\">mkdir</span> /mnt/mnist <span class=\"token comment\"># 사실 꼭 안해도 자동으로 생성된다.</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<details>\n<summary>pv-volume.yaml</summary>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-yaml line-numbers\"><code class=\"language-yaml\">    <span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n    <span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> PersistentVolume\n    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> mnist<span class=\"token punctuation\">-</span>pv<span class=\"token punctuation\">-</span>volume\n      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> local\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">storageClassName</span><span class=\"token punctuation\">:</span> mnist\n      <span class=\"token key atrule\">capacity</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">storage</span><span class=\"token punctuation\">:</span> 3Gi\n      <span class=\"token key atrule\">accessModes</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> ReadWriteOnce\n      <span class=\"token key atrule\">hostPath</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"/mnt/mnist\"</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</details>\n<details>    \n<summary>pv-claim.yaml</summary>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-yaml line-numbers\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> PersistentVolumeClaim\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> mnist<span class=\"token punctuation\">-</span>pv<span class=\"token punctuation\">-</span>claim\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">storageClassName</span><span class=\"token punctuation\">:</span> mnist\n  <span class=\"token key atrule\">accessModes</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> ReadWriteOnce\n  <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">requests</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">storage</span><span class=\"token punctuation\">:</span> 3Gi</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</details>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">kubectl apply -f pv-volume.yaml\nkubectl apply -f pv-claim.yaml</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>위를 각각 실행하면 아래와 같이 PV에서 PVC가 적용된 것을 확인할 수 있고 PVC에서도 확인할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\"><span class=\"token operator\">></span> kubectl get <span class=\"token function\">pv</span>\nNAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM                          STORAGECLASS   REASON   AGE\nmnist-pv-volume                            3Gi        RWO            Retain           Bound       default/mnist-pv-claim         mnist                   9m11s\n\n<span class=\"token operator\">></span> kubectl get pvc\nNAME             STATUS   VOLUME            CAPACITY   ACCESS MODES   STORAGECLASS   AGE\nmnist-pv-claim   Bound    mnist-pv-volume   3Gi        RWO            mnist          8m25s</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id=\"✓-mnist-train--save-model-in-pvc\" style=\"position:relative;\"><a href=\"#%E2%9C%93-mnist-train--save-model-in-pvc\" aria-label=\"✓ mnist train  save model in pvc permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><strong>✓ MNIST Train &#x26; Save Model in PVC</strong></h4>\n<p>쿠버네티스에서 배포를 위한 가장 작은 단위인 Pod는 여러개의 워커로드 즉, 애플리케이션 위에서 동작한다. Task에 따라 적절한 애플리케이션을 선택해야한다.</p>\n<p>하나의 Pod를 생성하고 안정적으로 실행하는게 초점을 맞춘 Job이 MNIST 모델 학습을 위해 적절하다고 판단하였다.</p>\n<details>\n<summary>mnist-train-job.yaml</summary>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-yaml line-numbers\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> batch/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Job\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> mnist<span class=\"token punctuation\">-</span>train<span class=\"token punctuation\">-</span>job\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> mnist<span class=\"token punctuation\">-</span>storage\n          <span class=\"token key atrule\">persistentVolumeClaim</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">claimName</span><span class=\"token punctuation\">:</span> mnist<span class=\"token punctuation\">-</span>pv<span class=\"token punctuation\">-</span>claim\n\n      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> mnist<span class=\"token punctuation\">-</span>train<span class=\"token punctuation\">-</span>container\n          <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> ssuwani/mnist_train\n          <span class=\"token key atrule\">args</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"--epochs\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"1\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"--save-model\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"--save-model-path\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"/app/mnist.pt\"</span><span class=\"token punctuation\">]</span>\n          <span class=\"token key atrule\">volumeMounts</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">mountPath</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"/app\"</span>\n              <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> mnist<span class=\"token punctuation\">-</span>storage\n      <span class=\"token key atrule\">restartPolicy</span><span class=\"token punctuation\">:</span> Never\n  <span class=\"token key atrule\">backoffLimit</span><span class=\"token punctuation\">:</span> <span class=\"token number\">4</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</details>\n    \n    \n<p><code class=\"language-text\">.spec.volumes</code>를 보면 이전에 만든 <code class=\"language-text\">mnist-pv-claim</code> 를 사용하는 <code class=\"language-text\">mnist-storage</code>를 생성한 것을 확인할 수 있다. 또한 <code class=\"language-text\">ssuwani/mnist_train</code> 를 실행하는 컨테이너가 <code class=\"language-text\">mnist-storage</code>를 <code class=\"language-text\">/app</code> 위치로 마운트했다.</p>\n<p><strong>Job 실행</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">kubectl apply -f mnist-train-job.yaml</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p><strong>결과확인</strong></p>\n<p>Job과 Pod를 확인하고 실행된 Pod의 Log를 확인해보면 동작이 잘 되었는지 확인할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\"><span class=\"token operator\">></span> kubectl get job\nNAME              COMPLETIONS   DURATION   AGE\nmnist-train-job   <span class=\"token number\">1</span>/1           27s        7m11s\n\n<span class=\"token operator\">></span> kubectl get pods\nNAME                    READY   STATUS      RESTARTS   AGE\nmnist-train-job-twdvv   <span class=\"token number\">0</span>/1     Completed   <span class=\"token number\">0</span>          7m14s\n\n<span class=\"token operator\">></span> kubectl logs mnist-train-job-twdvv\n<span class=\"token number\">100.0</span>% <span class=\"token comment\"># MNIST 데이터를 다운받는 과정이다.</span>\n<span class=\"token number\">102.8</span>%\n<span class=\"token number\">100.0</span>%\n<span class=\"token number\">112.7</span>%\n--- 이하 생략</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>또한 학습이 종료되면서 PVC로 연결된 위치에 모델을 저장하였다. 노드 셸에 접속하여 연결 해 둔 <code class=\"language-text\">/mnt/mnist</code> 폴더에 잘 저장이 되었는지 확인해보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\"><span class=\"token operator\">></span> minikube <span class=\"token function\">ssh</span>\nLast login: Tue Oct <span class=\"token number\">12</span> 08:38:50 <span class=\"token number\">2021</span> from <span class=\"token number\">192.168</span>.49.1\ndocker@minikube:~$ <span class=\"token function\">ls</span> /mnt/mnist/\n\nmnist.pt <span class=\"token comment\"># >&lt;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id=\"✓-mnist-serving-deployment--service\" style=\"position:relative;\"><a href=\"#%E2%9C%93-mnist-serving-deployment--service\" aria-label=\"✓ mnist serving deployment  service permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><strong>✓ MNIST Serving (Deployment + Service)</strong></h4>\n<p>Flask 를 실행하는 이미지를 쿠버네티스 디플로이먼트를 만들고 서비스로 만들어보자</p>\n<details>\n<summary>mnist-serving.yaml</summary>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-yaml line-numbers\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> mnist<span class=\"token punctuation\">-</span>serving<span class=\"token punctuation\">-</span>deployment\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> mnist<span class=\"token punctuation\">-</span>serving\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> mnist<span class=\"token punctuation\">-</span>serving\n  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> mnist<span class=\"token punctuation\">-</span>serving\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> mnist<span class=\"token punctuation\">-</span>serving\n        <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> ssuwani/mnist_app\n        <span class=\"token key atrule\">args</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"--model_path\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"/app/mnist.pt\"</span><span class=\"token punctuation\">]</span>\n        <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">containerPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5000</span>\n        <span class=\"token key atrule\">volumeMounts</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">mountPath</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"/app\"</span>\n            <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> mnist<span class=\"token punctuation\">-</span>storage\n      <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> mnist<span class=\"token punctuation\">-</span>storage\n          <span class=\"token key atrule\">persistentVolumeClaim</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">claimName</span><span class=\"token punctuation\">:</span> mnist<span class=\"token punctuation\">-</span>pv<span class=\"token punctuation\">-</span>claim</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</details>\n    \n    \n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">k apply -f mnist-serving.yaml</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>Deployment는 <code class=\"language-text\">.spec.replicas</code> 즉 레플리카셋을 기본적으로 설정할 수 있다. 파일의 내용과 같이 <code class=\"language-text\">replicas: 3</code> 로 설정하면 Pod를 3개 만든다는 이야기다. 이에 따른 강점을 영상으로 잠깐 찍어봤다.</p>\n<video width=\"480\" controls>\n  <source src=\"/750b0ed89b0fc0ffa6c45cba2a7e4dae/replicas-test.mov\" type=\"video/mp4\">\n</video>\n<p>Train 때와 마찬가지로 만들어진 Pod의 Logs를 확인해보자</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\"><span class=\"token operator\">></span> kubectl get pods\nNAME                                        READY   STATUS      RESTARTS   AGE\nmnist-serving-deployment-5994976558-78cm6   <span class=\"token number\">1</span>/1     Running     <span class=\"token number\">0</span>          4m32s\n--- 생략 ---\n\n<span class=\"token operator\">></span> k logs mnist-serving-deployment-5994976558-78cm6\n--- 생략 ---\n * Running on http://172.17.0.73:5000/ <span class=\"token punctuation\">(</span>Press CTRL+C to quit<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 잘 실행된 걸 확인할 수 있다.</span>\n--- 생략 ---</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>위의 logs에서  <code class=\"language-text\">* Running on [http://172.17.0.73:5000/](http://172.17.0.73:5000/)</code> 가 보인다. 이는 쿠버네티스 클러스터의 내부주소이다. 클러스터 내부에선 접속이 가능하지만 로컬 혹은 원격에선 접속하기 어렵다. 이게 서비스를 이용하는 가장 큰 이유라고 생각한다. </p>\n<p>클러스터 내부에서 접속이 가능하다는 걸 증명해보자. 간단하다 minikube ssh 로 노드 셸에 접속해서 연결을 확인해보자</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\"><span class=\"token operator\">></span> minikube <span class=\"token function\">ssh</span>\nLast login: Tue Oct <span class=\"token number\">12</span> 09:31:23 <span class=\"token number\">2021</span> from <span class=\"token number\">192.168</span>.49.1\n\ndocker@minikube:~$ <span class=\"token function\">curl</span> http://172.17.0.73:5000/\n<span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"error\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"use POST /prediction instead of root route\"</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>출력은 에러라고 나와서 혼란이 있을 수 있지만 내가 설정해놓은 리턴값이다. 정상적으로 실행되었다.</p>\n<p><strong>서비스 연결하기</strong></p>\n<details>\n<summary>mnist-serving-service.yaml</summary>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-yaml line-numbers\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Service\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> mnist<span class=\"token punctuation\">-</span>service\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> mnist<span class=\"token punctuation\">-</span>serving\n  <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> TCP\n      <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1234</span>\n      <span class=\"token key atrule\">targetPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5000</span>\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> NodePort</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</details>\n<p>selector로 서비스 대상을 결정한다. 위에서 <code class=\"language-text\">mnist-serving.yaml</code> 에서 <code class=\"language-text\">.spec.template.metadata.labels</code> 로 생성된 Pod의 Label의 일치를 계속해서 추적한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-yaml line-numbers\"><code class=\"language-yaml\"><span class=\"token comment\"># mnist-serving.yaml</span>\n<span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> mnist<span class=\"token punctuation\">-</span>serving\n\n\n<span class=\"token comment\"># mnist-serving-service.yaml</span>\n<span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n\t<span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> mnist<span class=\"token punctuation\">-</span>serving</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>서비스 실행하기</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">kubectl apply -f mnist-serving-service.yaml</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>서비스가 잘 생성되었는지 확인해보자</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\"><span class=\"token operator\">></span> kubectl get services\nNAME            TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class=\"token punctuation\">(</span>S<span class=\"token punctuation\">)</span>          AGE\nmnist-service   NodePort    <span class=\"token number\">10.103</span>.250.89   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>        <span class=\"token number\">1234</span>:31322/TCP   28m\n\n<span class=\"token operator\">></span> kubectl describe services/mnist-service\nName:                     mnist-service\nNamespace:                default\nLabels:                   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nAnnotations:              <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nSelector:                 <span class=\"token assign-left variable\">app</span><span class=\"token operator\">=</span>mnist-serving\nType:                     NodePort\nIP Families:              <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nIP:                       <span class=\"token number\">10.103</span>.250.89\nIPs:                      <span class=\"token number\">10.103</span>.250.89\nPort:                     <span class=\"token operator\">&lt;</span>unset<span class=\"token operator\">></span>  <span class=\"token number\">1234</span>/TCP\nTargetPort:               <span class=\"token number\">5000</span>/TCP\nNodePort:                 <span class=\"token operator\">&lt;</span>unset<span class=\"token operator\">></span>  <span class=\"token number\">31322</span>/TCP\nEndpoints:                <span class=\"token number\">172.17</span>.0.72:5000,172.17.0.73:5000,172.17.0.74:5000\nSession Affinity:         None\nExternal Traffic Policy:  Cluster\nEvents:                   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>NodePort가 31322로 잡혀있고 EndPoint로 3개의 Pod가 잘 잡혀있는것을 확인할 수 있다. 서비스의 포트와 노드포트에 대한 내용이 이해될 듯 조금 헷갈린다.. 더 공부하자.</p>\n<p><code class=\"language-text\">{clusterIP}:{NodePort}</code> 에 접근하면 노드포트에 연결된 Pod에 접근할 수 있다. 어떤 파드에 접근할지는 쿠버네티스가 알아서 정해준다.</p>\n<p>어떻게 알아서 정해주냐는 너무 깊은 이야기지만 실험을 통해 실제로 적절히 알아서 정해주는지 확인해보았다.</p>\n<p>영상의 왼쪽은 watch 명령어로 3개의 Pod의 Log를 확인하고 있다. </p>\n<p>영상의 오른쪽은 curl 명령어로 0.5초마다 한번씩 NodePort를 통해 Pod에 요청을 보냈다.</p>\n<ul>\n<li>\n<p>명령어</p>\n<p>watch log</p>\n<p><code class=\"language-text\">watch -n1 &quot;kubectl logs mnist-serving-deployment-5994976558-8hhcx | tail -n $(($LINES - 2))&quot;</code></p>\n<p>curl + while</p>\n<p><code class=\"language-text\">while true; do sleep 0.5; curl 192.168.49.2:31322; done;</code></p>\n</li>\n</ul>\n<video width=\"480\" controls>\n  <source src=\"/a9250c7acbca08e1ce46289151c0492d/NodePort.mov\" type=\"video/mp4\">\n</video>\n<p>너무 길어지지만 하나 더 하고 넘어가야한다.</p>\n<p>클러스터 IP로 Service에 접근할 수 있지만 이 또한 분명 내 PC에서 동작하는 클러스터이기 때문에 외부에서 접근할 수 없다. 쿠버네티스에선 포트포워딩을 이용해 클러스터 내 애플리케이션에 접근이 가능하다.</p>\n<p>이를 통해 ClusterIP + NodePort로 접근했던 것이 Local IP + Local Port 로 접근이 가능해지는 것이다. 이는 또 Local PC가 연결된 네트워크의 포트포워딩을 통해 외부 IP로서도 접근이 가능하다는 이야기다. </p>\n<p>포트포워딩으로 클러스터 내 애플리케이션에 접근 (로컬포트와 서비스포트의 연결)</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">kubectl port-forward service/mnist-service <span class=\"token number\">5000</span>:1234\n<span class=\"token comment\"># 이는 </span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>참고: kubectl port-forward 는 프롬프트를 리턴하지 않으므로, 이 연습을 계속하려면 다른 터미널을 열어야 한다.  (<a href=\"https://kubernetes.io/ko/docs/tasks/access-application-cluster/port-forward-access-application-cluster/\">참조</a>)</p>\n<p>5000은 로컬 포트를 1234는 위에서 <code class=\"language-text\">kubectl describe services/mnist-service</code> 를 실행해 보았던 Service Port이다. </p>\n<p>이제 <a href=\"http://localhost:5000\">localhost:5000</a> 는 서비스포트 1234에 접근하는 것과 동일하다. 이는 또 다시 ClusterIP + NodePort와 동일하다. </p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\"><span class=\"token comment\"># 또 다른 터미널을 열어 확인하였다.</span>\n<span class=\"token operator\">></span> <span class=\"token function\">curl</span> localhost:5000\n<span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"error\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"use POST /prediction instead of root route\"</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<ul>\n<li>\n<p>local IP가 아니라 외부 IP에서도 접근할 수 있게 설정하기</p>\n<p>쿠버네티스가 동작하는 PC의 네트워크의 포트포워딩을 해야한다. 나의 경우 내 PC는 iptime 공유기에 연결되어 있다. </p>\n<p>iptime의 경우 고급설정 - NAT/라우터 관리 - 포트포워드 설정에서 다음과 같이 설정을 추가해주면 된다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d312e57426ffae3155fdabef74eb9bbe/203d3/Untitled.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 4.25531914893617%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAAAsSAAALEgHS3X78AAAAUUlEQVQI1x3KSwqAIABF0fa/oD4EWTgwyBKjsAwaBUkt4qbN3j28rOoMbe/Qy0UtLamVObH+YXL3b0WjKcSIHDzz8SLUSh6tjJZ2+potYPfAB65QRAlC/FnKAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Untitled\"\n        title=\"Untitled\"\n        src=\"/static/d312e57426ffae3155fdabef74eb9bbe/1d69c/Untitled.png\"\n        srcset=\"/static/d312e57426ffae3155fdabef74eb9bbe/4dcb9/Untitled.png 188w,\n/static/d312e57426ffae3155fdabef74eb9bbe/5ff7e/Untitled.png 375w,\n/static/d312e57426ffae3155fdabef74eb9bbe/1d69c/Untitled.png 750w,\n/static/d312e57426ffae3155fdabef74eb9bbe/78797/Untitled.png 1125w,\n/static/d312e57426ffae3155fdabef74eb9bbe/203d3/Untitled.png 1322w\"\n        sizes=\"(max-width: 750px) 100vw, 750px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>그리고 포트포워딩 할 때 하나의 옵션을 추가해야 한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">kubectl port-forward service/mnist-service <span class=\"token number\">5000</span>:1234 --address <span class=\"token number\">0.0</span>.0.0</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>address 에 대한 부분인데 기본값은 <a href=\"http://localhost\">localhost</a> 즉 127.0.0.1 이다. 이를 모든 네트워크에서 접근 가능하도록 0.0.0.0 으로 변경해주었다.</p>\n<p>이제 나는 지금 카페에 있는데 집에 있는 PC의 외부 IP + 5000 으로 쿠버네티스 Cluster 위에서 동작하는 Pod에 접근할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\"><span class=\"token punctuation\">(</span>base<span class=\"token punctuation\">)</span>  suwan@Suwan-mac  ~  <span class=\"token function\">curl</span> <span class=\"token number\">182.161</span>.xxx.200:5000\n<span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"error\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"use POST /prediction instead of root route\"</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n</ul>\n<h4 id=\"✓-run-react-app\" style=\"position:relative;\"><a href=\"#%E2%9C%93-run-react-app\" aria-label=\"✓ run react app permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><strong>✓ Run React App</strong></h4>\n<p>사용자가 이미지를 입력하고 결과를 확인할 수 있는 웹 애플리케이션을 React로 만들었다. Kubernetes 위에 배포해보자.</p>\n<p>방금전에 한 MNIST Serving 과 거의 똑같다. Deployment를 만들고 Service 연결하면된다.</p>\n<details>\n<summary>mnist-web.yaml</summary>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-yaml line-numbers\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> mnist<span class=\"token punctuation\">-</span>web<span class=\"token punctuation\">-</span>deployment\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> mnist<span class=\"token punctuation\">-</span>web\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> mnist<span class=\"token punctuation\">-</span>web\n  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> mnist<span class=\"token punctuation\">-</span>web\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> mnist<span class=\"token punctuation\">-</span>web\n          <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> ssuwani/mnist_web<span class=\"token punctuation\">-</span>app</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</details>\n<details>\n<summary>mnist-web-service.yaml</summary>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-yaml line-numbers\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Service\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> mnist<span class=\"token punctuation\">-</span>web<span class=\"token punctuation\">-</span>service\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> mnist<span class=\"token punctuation\">-</span>web\n  <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> TCP\n      <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n      <span class=\"token key atrule\">targetPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> NodePort</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<details>\n  \n    \n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">kubectl apply -f mnist-web.yaml\nkubectl apply -f mnist-web-service.yaml</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p><strong>동작확인</strong></p>\n<p>위에서 했던 것처럼 Cluster IP + NodePort 에 접근하면 정상적으로 동작을 확인할 수 있다. Local에서 클러스터 애플리케이션에 접근하기 위해 kubectl port-forward 해보자</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">kubectl port-forward service/mnist-web-service <span class=\"token number\">8888</span>:80</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p><a href=\"http://localhost:8888\">localhost:8888</a> 에 접근해보자</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/576c4ebf6b24d4d99866c9ce64ba3a8f/d9ed5/Untitled1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 52.659574468085104%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAAA70lEQVQoz62SwWqEMBRF/f9v6bL7rrrrquCiQjVKwIaoRI2JUZPbSawgUzvjQB8cngl5hyu8yDmHPb7mecY4jpimCcsyh7P/9hhjYK0N765nPdGRkHOOJEmQ5znKskSapiiKAoQQUEqhlHpM6NP1vUTXdRBChN62bUi3ljuU/RJauwrjD4Gn5wJVY37G8WeiUwm7XuOLCZhpuZnmrtAPW7flOZ/q7i/nVOHlleOTyIelh0JCBd7eORjXa+rLmpwW4p8r0lpjj18Z34dBXRggpQzd3++5ntuI6rrGRlVVaJomLHQcx4Esy8AYw/7dLb4BGe9ce8bzgmYAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Untitled\"\n        title=\"Untitled\"\n        src=\"/static/576c4ebf6b24d4d99866c9ce64ba3a8f/1d69c/Untitled1.png\"\n        srcset=\"/static/576c4ebf6b24d4d99866c9ce64ba3a8f/4dcb9/Untitled1.png 188w,\n/static/576c4ebf6b24d4d99866c9ce64ba3a8f/5ff7e/Untitled1.png 375w,\n/static/576c4ebf6b24d4d99866c9ce64ba3a8f/1d69c/Untitled1.png 750w,\n/static/576c4ebf6b24d4d99866c9ce64ba3a8f/78797/Untitled1.png 1125w,\n/static/576c4ebf6b24d4d99866c9ce64ba3a8f/aa440/Untitled1.png 1500w,\n/static/576c4ebf6b24d4d99866c9ce64ba3a8f/d9ed5/Untitled1.png 2880w\"\n        sizes=\"(max-width: 750px) 100vw, 750px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>최종 동작 확인을 위해 mnist-service에 다시 연결해보자</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">kubectl port-forward service/mnist-service <span class=\"token number\">5000</span>:1234</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>이제 <a href=\"http://localhost:5000\">localhost:5000</a> 을 통해 MNIST Serving Flask APP 에 접근할 수 있다.</p>\n<p>아래의 이미지를 다운받아서 결과가 잘 나오는지 확인해보자</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 28px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3259622e110dbdbf330e3b63b7777010/dcb9a/img_0.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGAABAQEBAQAAAAAAAAAAAAAAAAIFAwT/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIQAxAAAAHF9U9TMAoJB//EABsQAAMAAgMAAAAAAAAAAAAAAAECAwAQBBIT/9oACAEBAAEFApTNXaUvDOKOxRWjHRYtr//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8BH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8BH//EAB8QAAIBBAIDAAAAAAAAAAAAAAECEgADEBETISJBkf/aAAgBAQAGPwKI+0z2yxie94dPbLoVd5BGQ0Ac+RJx/8QAHBABAAEFAQEAAAAAAAAAAAAAAREAEDFBUWFx/9oACAEBAAE/ISKBtWApiMMW3tomYb9eVJ7C3DbFNTCdZt//2gAMAwEAAgADAAAAEPAPAP/EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8QH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8QH//EABwQAQACAgMBAAAAAAAAAAAAAAEAESExEEFRkf/aAAgBAQABPxC28joEWrCRcSAXoGQv3ihJ+LV4P0CR2oAlN2UPA7juCoRRNJDyEULUPM8f/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"img_0.jpg\"\n        title=\"img_0.jpg\"\n        src=\"/static/3259622e110dbdbf330e3b63b7777010/dcb9a/img_0.jpg\"\n        srcset=\"/static/3259622e110dbdbf330e3b63b7777010/dcb9a/img_0.jpg 28w\"\n        sizes=\"(max-width: 28px) 100vw, 28px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 28px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/26c0a28d9d53b9bf70d37c1fb8b153fa/dcb9a/img_1.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAQDBv/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAefonuIQNAzB/8QAGxAAAQQDAAAAAAAAAAAAAAAAAQACAxAEEjH/2gAIAQEAAQUCT49Y6yeUXEhf/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAwEBPwEf/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAgEBPwEf/8QAGxAAAQQDAAAAAAAAAAAAAAAAAQIDEDEAQWP/2gAIAQEABj8CxtW1S0OYkAmqj//EABsQAQACAgMAAAAAAAAAAAAAAAEQESFhAFGh/9oACAEBAAE/IeFeNK11mVpnpK+Ex0j/2gAMAwEAAgADAAAAEEAIAP/EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8QH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8QH//EAB4QAQACAgEFAAAAAAAAAAAAAAERMQAQIUFRYYGh/9oACAEBAAE/EC8kbK4cAge70ZwYBwjvJfui8LsyD0XB41//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"img_1.jpg\"\n        title=\"img_1.jpg\"\n        src=\"/static/26c0a28d9d53b9bf70d37c1fb8b153fa/dcb9a/img_1.jpg\"\n        srcset=\"/static/26c0a28d9d53b9bf70d37c1fb8b153fa/dcb9a/img_1.jpg 28w\"\n        sizes=\"(max-width: 28px) 100vw, 28px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 28px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/481fc219229573667e874d45c37bc7d9/dcb9a/img_2.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGAABAQEBAQAAAAAAAAAAAAAAAAIFBAb/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIQAxAAAAHD0o7Tz6hIAP/EABoQAAMBAAMAAAAAAAAAAAAAAAECAwQAEBH/2gAIAQEAAQUCQAuc8WHM8JOgbLJiPG7/AP/EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8BH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8BH//EAB8QAAICAgEFAAAAAAAAAAAAAAECESEAAxASIDFRUv/aAAgBAQAGPwIBjA94w07JZbvgs738zGEI1sI6vIGETPZ//8QAHRABAAEEAwEAAAAAAAAAAAAAAREAIUFhECBRsf/aAAgBAQABPyGbXt/FMnNoTXFphcH1TdiqCIBBiTPT/9oADAMBAAIAAwAAABBgAAD/xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAEDAQE/EB//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/EB//xAAeEAEAAgIBBQAAAAAAAAAAAAABESEAUTEQIGGB8P/aAAgBAQABPxCOhBFMN4mDrBSLFBfQn4oAyNr7YgFTDd2/GEQDDig8njs//9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"img_2.jpg\"\n        title=\"img_2.jpg\"\n        src=\"/static/481fc219229573667e874d45c37bc7d9/dcb9a/img_2.jpg\"\n        srcset=\"/static/481fc219229573667e874d45c37bc7d9/dcb9a/img_2.jpg 28w\"\n        sizes=\"(max-width: 28px) 100vw, 28px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h4 id=\"✓-etc\" style=\"position:relative;\"><a href=\"#%E2%9C%93-etc\" aria-label=\"✓ etc permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><strong>✓ ETC</strong></h4>\n<ul>\n<li>\n<p>Service Type(NodePort) 에 대한 내용 더 공부하자.</p>\n<p><a href=\"https://kubernetes.io/ko/docs/concepts/services-networking/service/\">서비스</a></p>\n</li>\n</ul>","tableOfContents":"<ul>\n<li>\n<p><a href=\"/category/blog/mnist-classification/4-kubernetes/#kubernetes-%EC%9C%84%EC%97%90-%EC%98%AC%EB%A0%A4%EB%B3%B4%EC%9E%90\">Kubernetes 위에 올려보자</a></p>\n<ul>\n<li>\n<ul>\n<li>\n<p><a href=\"/category/blog/mnist-classification/4-kubernetes/#-stack\">📚 Stack</a></p>\n<ul>\n<li><a href=\"/category/blog/mnist-classification/4-kubernetes/#%E2%9C%93-pv--pvc\"><strong>✓ PV &#x26; PVC</strong></a></li>\n<li><a href=\"/category/blog/mnist-classification/4-kubernetes/#%E2%9C%93-mnist-train--save-model-in-pvc\"><strong>✓ MNIST Train &#x26; Save Model in PVC</strong></a></li>\n<li><a href=\"/category/blog/mnist-classification/4-kubernetes/#%E2%9C%93-mnist-serving-deployment--service\"><strong>✓ MNIST Serving (Deployment + Service)</strong></a></li>\n<li><a href=\"/category/blog/mnist-classification/4-kubernetes/#%E2%9C%93-run-react-app\"><strong>✓ Run React App</strong></a></li>\n<li><a href=\"/category/blog/mnist-classification/4-kubernetes/#%E2%9C%93-etc\"><strong>✓ ETC</strong></a></li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>","frontmatter":{"title":"[MNIST Classification - 4] Kubernetes 위에 올려보자","description":"","date":"2021.10.12","emoji":"📚","category":"blog"}}},"pageContext":{"slug":"/category/blog/mnist-classification/4-kubernetes/","relatedPosts":[{"node":{"fields":{"slug":"/category/blog/interview/"},"frontmatter":{"title":"[면접준비] minimum 질문&답변","date":"2021.11.22","emoji":"❓","category":"blog"}}},{"node":{"fields":{"slug":"/category/blog/hackerrank_certification/"},"frontmatter":{"title":"해커랭크 인증서 발급 후기","date":"2021.11.19","emoji":"📚","category":"blog"}}},{"node":{"fields":{"slug":"/category/blog/m1-tensorflow/"},"frontmatter":{"title":"[Tensorflow] M1에서 Tensorflow GPU 사용하기 (Monterey)","date":"2021.11.13","emoji":"💪","category":"blog"}}},{"node":{"fields":{"slug":"/category/blog/effective-python/"},"frontmatter":{"title":"[책] 파이썬 코딩의 기술","date":"2021.11.02","emoji":"📚","category":"blog"}}},{"node":{"fields":{"slug":"/category/blog/mlops/simple_model_deploy_mnist/"},"frontmatter":{"title":"[MLOps] Vertex AI에서 모델 배포하기 (MNIST)","date":"2021.11.01","emoji":"🏃","category":"blog"}}}]}}}