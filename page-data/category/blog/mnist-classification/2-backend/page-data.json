{"componentChunkName":"component---src-templates-post-tsx","path":"/category/blog/mnist-classification/2-backend/","result":{"data":{"site":{"siteMetadata":{"title":"어서OpShow","author":"장수완","siteUrl":"https://ssuwani.github.io"}},"markdownRemark":{"id":"ead44676-efb3-5bb0-a10d-4b02370ae898","excerpt":"MNIST 학습 및 모델 서빙 실험 날짜: 2021년 10월 9일\n실험자: Suwan Jang 학습된 모델을 불러와 프론트엔드에서 전달받은 이미지를 분석하고 결과를 반환한다. 📚 Stack Flask PyTorch (M1 Mac에서 Tensorflow가 넘 귀찮다..) Todo…","html":"<h1 id=\"mnist-학습-및-모델-서빙\" style=\"position:relative;\"><a href=\"#mnist-%ED%95%99%EC%8A%B5-%EB%B0%8F-%EB%AA%A8%EB%8D%B8-%EC%84%9C%EB%B9%99\" aria-label=\"mnist 학습 및 모델 서빙 permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>MNIST 학습 및 모델 서빙</h1>\n<p>실험 날짜: 2021년 10월 9일\n실험자: Suwan Jang</p>\n<p>학습된 모델을 불러와 프론트엔드에서 전달받은 이미지를 분석하고 결과를 반환한다.</p>\n<h3 id=\"-stack\" style=\"position:relative;\"><a href=\"#-stack\" aria-label=\" stack permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>📚 Stack</h3>\n<ul>\n<li>Flask</li>\n<li>PyTorch (M1 Mac에서 Tensorflow가 넘 귀찮다..)</li>\n</ul>\n<p><strong>Todo</strong></p>\n<ul>\n<li class=\"task-list-item\"><input type=\"checkbox\" checked disabled>  Flask Project Structure</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" checked disabled>  Make model</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" checked disabled>  Train &#x26; Save Model code</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" checked disabled>  Load Model &#x26; Prediction</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" checked disabled>  Flask Project Complete</li>\n</ul>\n<p>학습과 테스트를 위한 코드는 여기를 참고했습니다!!(거의 똑같음)\n모델 성능 향상을 테스트 하기 위해 DNN 모델, epochs: 1 로 학습하였습니다.</p>\n<p><a href=\"https://github.com/pytorch/examples/blob/master/mnist/main.py\">examples/main.py at master · pytorch/examples</a></p>\n<h2 id=\"logs\" style=\"position:relative;\"><a href=\"#logs\" aria-label=\"logs permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Logs</h2>\n<hr>\n<p><strong>✓ Flask Project Structure</strong></p>\n<ul>\n<li>\n<p><code class=\"language-text\">app.py</code></p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-python line-numbers\"><code class=\"language-python\"><span class=\"token keyword\">from</span> flask <span class=\"token keyword\">import</span> Flask\n\napp <span class=\"token operator\">=</span> Flask<span class=\"token punctuation\">(</span>__name__<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># Load Model</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">preprocessing</span><span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"Preprocessing Function\n\n    Input:\n        Image\n    Output:\n        Image\n    \"\"\"</span>\n    <span class=\"token comment\"># return image</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">predict</span><span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"Predict Function\n\n    Input:\n        Image\n    Output:\n        value\n    \"\"\"</span>\n\n    <span class=\"token comment\"># return value</span>\n\n<span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>route</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">root_route</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"error\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"use POST /prediction instead of root route\"</span><span class=\"token punctuation\">}</span>\n\n<span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>route</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">prediction_route</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"Prediction Router\n\n    Input:\n        formData from Flask\n    Output:\n        Json: (\"class_name\": value)\n        example:\n             {\"class_name\": 1}\n    \"\"\"</span>\n\n    <span class=\"token comment\"># return {\"class_name\": value}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>Load Model</li>\n<li>Preprocess function</li>\n<li>Predict function</li>\n<li>root router</li>\n<li>prediction router</li>\n</ul>\n<p><strong>✓ Make model</strong></p>\n<ul>\n<li>\n<p><code class=\"language-text\">train.py</code></p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-python line-numbers\"><code class=\"language-python\"><span class=\"token keyword\">import</span> torch\n<span class=\"token keyword\">import</span> torch<span class=\"token punctuation\">.</span>nn <span class=\"token keyword\">as</span> nn\n<span class=\"token keyword\">import</span> torch<span class=\"token punctuation\">.</span>nn<span class=\"token punctuation\">.</span>functional <span class=\"token keyword\">as</span> F\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Net</span><span class=\"token punctuation\">(</span>nn<span class=\"token punctuation\">.</span>Module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span>Net<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>fc1 <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>Linear<span class=\"token punctuation\">(</span><span class=\"token number\">28</span> <span class=\"token operator\">*</span> <span class=\"token number\">28</span><span class=\"token punctuation\">,</span> <span class=\"token number\">128</span><span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>fc2 <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>Linear<span class=\"token punctuation\">(</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">forward</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        x <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>flatten<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n        x <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>fc1<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span>\n        x <span class=\"token operator\">=</span> F<span class=\"token punctuation\">.</span>relu<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span>\n        x <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>fc2<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span>\n        output <span class=\"token operator\">=</span> F<span class=\"token punctuation\">.</span>log_softmax<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> dim<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> output</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n</ul>\n<p><strong>✓ Train &#x26; Save Model</strong></p>\n<ul>\n<li>\n<p><code class=\"language-text\">train.py</code></p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-python line-numbers\"><code class=\"language-python\"><span class=\"token keyword\">from</span> __future__ <span class=\"token keyword\">import</span> print_function\n<span class=\"token keyword\">import</span> argparse\n<span class=\"token keyword\">import</span> torch\n<span class=\"token keyword\">import</span> torch<span class=\"token punctuation\">.</span>nn<span class=\"token punctuation\">.</span>functional <span class=\"token keyword\">as</span> F\n<span class=\"token keyword\">import</span> torch<span class=\"token punctuation\">.</span>optim <span class=\"token keyword\">as</span> optim\n<span class=\"token keyword\">from</span> torchvision <span class=\"token keyword\">import</span> datasets<span class=\"token punctuation\">,</span> transforms\n<span class=\"token keyword\">from</span> torch<span class=\"token punctuation\">.</span>optim<span class=\"token punctuation\">.</span>lr_scheduler <span class=\"token keyword\">import</span> StepLR\n<span class=\"token keyword\">from</span> model <span class=\"token keyword\">import</span> Net\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">train</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">,</span> model<span class=\"token punctuation\">,</span> device<span class=\"token punctuation\">,</span> train_loader<span class=\"token punctuation\">,</span> optimizer<span class=\"token punctuation\">,</span> epoch<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    model<span class=\"token punctuation\">.</span>train<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">for</span> batch_idx<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">,</span> target<span class=\"token punctuation\">)</span> <span class=\"token keyword\">in</span> <span class=\"token builtin\">enumerate</span><span class=\"token punctuation\">(</span>train_loader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        data<span class=\"token punctuation\">,</span> target <span class=\"token operator\">=</span> data<span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">(</span>device<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> target<span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">(</span>device<span class=\"token punctuation\">)</span>\n        optimizer<span class=\"token punctuation\">.</span>zero_grad<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        output <span class=\"token operator\">=</span> model<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span>\n        loss <span class=\"token operator\">=</span> F<span class=\"token punctuation\">.</span>nll_loss<span class=\"token punctuation\">(</span>output<span class=\"token punctuation\">,</span> target<span class=\"token punctuation\">)</span>\n        loss<span class=\"token punctuation\">.</span>backward<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        optimizer<span class=\"token punctuation\">.</span>step<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> batch_idx <span class=\"token operator\">%</span> args<span class=\"token punctuation\">.</span>log_interval <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>\n                <span class=\"token string\">\"Train Epoch: {} [{}/{} ({:.0f}%)]\\tLoss: {:.6f}\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>\n                    epoch<span class=\"token punctuation\">,</span>\n                    batch_idx <span class=\"token operator\">*</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                    <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>train_loader<span class=\"token punctuation\">.</span>dataset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                    <span class=\"token number\">100.0</span> <span class=\"token operator\">*</span> batch_idx <span class=\"token operator\">/</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>train_loader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                    loss<span class=\"token punctuation\">.</span>item<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">if</span> args<span class=\"token punctuation\">.</span>dry_run<span class=\"token punctuation\">:</span>\n                <span class=\"token keyword\">break</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">test</span><span class=\"token punctuation\">(</span>model<span class=\"token punctuation\">,</span> device<span class=\"token punctuation\">,</span> test_loader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    model<span class=\"token punctuation\">.</span><span class=\"token builtin\">eval</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    test_loss <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n    correct <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n    <span class=\"token keyword\">with</span> torch<span class=\"token punctuation\">.</span>no_grad<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">for</span> data<span class=\"token punctuation\">,</span> target <span class=\"token keyword\">in</span> test_loader<span class=\"token punctuation\">:</span>\n            data<span class=\"token punctuation\">,</span> target <span class=\"token operator\">=</span> data<span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">(</span>device<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> target<span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">(</span>device<span class=\"token punctuation\">)</span>\n            output <span class=\"token operator\">=</span> model<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span>\n            test_loss <span class=\"token operator\">+=</span> F<span class=\"token punctuation\">.</span>nll_loss<span class=\"token punctuation\">(</span>\n                output<span class=\"token punctuation\">,</span> target<span class=\"token punctuation\">,</span> reduction<span class=\"token operator\">=</span><span class=\"token string\">\"sum\"</span>\n            <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>item<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># sum up batch loss</span>\n            pred <span class=\"token operator\">=</span> output<span class=\"token punctuation\">.</span>argmax<span class=\"token punctuation\">(</span>\n                dim<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> keepdim<span class=\"token operator\">=</span><span class=\"token boolean\">True</span>\n            <span class=\"token punctuation\">)</span>  <span class=\"token comment\"># get the index of the max log-probability</span>\n            correct <span class=\"token operator\">+=</span> pred<span class=\"token punctuation\">.</span>eq<span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">.</span>view_as<span class=\"token punctuation\">(</span>pred<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">sum</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>item<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    test_loss <span class=\"token operator\">/=</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>test_loader<span class=\"token punctuation\">.</span>dataset<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>\n        <span class=\"token string\">\"\\nTest set: Average loss: {:.4f}, Accuracy: {}/{} ({:.0f}%)\\n\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>\n            test_loss<span class=\"token punctuation\">,</span>\n            correct<span class=\"token punctuation\">,</span>\n            <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>test_loader<span class=\"token punctuation\">.</span>dataset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token number\">100.0</span> <span class=\"token operator\">*</span> correct <span class=\"token operator\">/</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>test_loader<span class=\"token punctuation\">.</span>dataset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># Training settings</span>\n    parser <span class=\"token operator\">=</span> argparse<span class=\"token punctuation\">.</span>ArgumentParser<span class=\"token punctuation\">(</span>description<span class=\"token operator\">=</span><span class=\"token string\">\"PyTorch MNIST Example\"</span><span class=\"token punctuation\">)</span>\n    parser<span class=\"token punctuation\">.</span>add_argument<span class=\"token punctuation\">(</span>\n        <span class=\"token string\">\"--batch-size\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">type</span><span class=\"token operator\">=</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span>\n        default<span class=\"token operator\">=</span><span class=\"token number\">64</span><span class=\"token punctuation\">,</span>\n        metavar<span class=\"token operator\">=</span><span class=\"token string\">\"N\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">help</span><span class=\"token operator\">=</span><span class=\"token string\">\"input batch size for training (default: 64)\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span>\n    parser<span class=\"token punctuation\">.</span>add_argument<span class=\"token punctuation\">(</span>\n        <span class=\"token string\">\"--test-batch-size\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">type</span><span class=\"token operator\">=</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span>\n        default<span class=\"token operator\">=</span><span class=\"token number\">1000</span><span class=\"token punctuation\">,</span>\n        metavar<span class=\"token operator\">=</span><span class=\"token string\">\"N\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">help</span><span class=\"token operator\">=</span><span class=\"token string\">\"input batch size for testing (default: 1000)\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span>\n    parser<span class=\"token punctuation\">.</span>add_argument<span class=\"token punctuation\">(</span>\n        <span class=\"token string\">\"--epochs\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">type</span><span class=\"token operator\">=</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span>\n        default<span class=\"token operator\">=</span><span class=\"token number\">14</span><span class=\"token punctuation\">,</span>\n        metavar<span class=\"token operator\">=</span><span class=\"token string\">\"N\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">help</span><span class=\"token operator\">=</span><span class=\"token string\">\"number of epochs to train (default: 14)\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span>\n    parser<span class=\"token punctuation\">.</span>add_argument<span class=\"token punctuation\">(</span>\n        <span class=\"token string\">\"--lr\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">type</span><span class=\"token operator\">=</span><span class=\"token builtin\">float</span><span class=\"token punctuation\">,</span>\n        default<span class=\"token operator\">=</span><span class=\"token number\">1.0</span><span class=\"token punctuation\">,</span>\n        metavar<span class=\"token operator\">=</span><span class=\"token string\">\"LR\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">help</span><span class=\"token operator\">=</span><span class=\"token string\">\"learning rate (default: 1.0)\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span>\n    parser<span class=\"token punctuation\">.</span>add_argument<span class=\"token punctuation\">(</span>\n        <span class=\"token string\">\"--gamma\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">type</span><span class=\"token operator\">=</span><span class=\"token builtin\">float</span><span class=\"token punctuation\">,</span>\n        default<span class=\"token operator\">=</span><span class=\"token number\">0.7</span><span class=\"token punctuation\">,</span>\n        metavar<span class=\"token operator\">=</span><span class=\"token string\">\"M\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">help</span><span class=\"token operator\">=</span><span class=\"token string\">\"Learning rate step gamma (default: 0.7)\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span>\n    parser<span class=\"token punctuation\">.</span>add_argument<span class=\"token punctuation\">(</span>\n        <span class=\"token string\">\"--no-cuda\"</span><span class=\"token punctuation\">,</span> action<span class=\"token operator\">=</span><span class=\"token string\">\"store_true\"</span><span class=\"token punctuation\">,</span> default<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">help</span><span class=\"token operator\">=</span><span class=\"token string\">\"disables CUDA training\"</span>\n    <span class=\"token punctuation\">)</span>\n    parser<span class=\"token punctuation\">.</span>add_argument<span class=\"token punctuation\">(</span>\n        <span class=\"token string\">\"--dry-run\"</span><span class=\"token punctuation\">,</span>\n        action<span class=\"token operator\">=</span><span class=\"token string\">\"store_true\"</span><span class=\"token punctuation\">,</span>\n        default<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">help</span><span class=\"token operator\">=</span><span class=\"token string\">\"quickly check a single pass\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span>\n    parser<span class=\"token punctuation\">.</span>add_argument<span class=\"token punctuation\">(</span>\n        <span class=\"token string\">\"--seed\"</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">type</span><span class=\"token operator\">=</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span> default<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> metavar<span class=\"token operator\">=</span><span class=\"token string\">\"S\"</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">help</span><span class=\"token operator\">=</span><span class=\"token string\">\"random seed (default: 1)\"</span>\n    <span class=\"token punctuation\">)</span>\n    parser<span class=\"token punctuation\">.</span>add_argument<span class=\"token punctuation\">(</span>\n        <span class=\"token string\">\"--log-interval\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">type</span><span class=\"token operator\">=</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span>\n        default<span class=\"token operator\">=</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span>\n        metavar<span class=\"token operator\">=</span><span class=\"token string\">\"N\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">help</span><span class=\"token operator\">=</span><span class=\"token string\">\"how many batches to wait before logging training status\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span>\n    parser<span class=\"token punctuation\">.</span>add_argument<span class=\"token punctuation\">(</span>\n        <span class=\"token string\">\"--save-model\"</span><span class=\"token punctuation\">,</span>\n        action<span class=\"token operator\">=</span><span class=\"token string\">\"store_true\"</span><span class=\"token punctuation\">,</span>\n        default<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">help</span><span class=\"token operator\">=</span><span class=\"token string\">\"For Saving the current Model\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span>\n    args <span class=\"token operator\">=</span> parser<span class=\"token punctuation\">.</span>parse_args<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    use_cuda <span class=\"token operator\">=</span> <span class=\"token keyword\">not</span> args<span class=\"token punctuation\">.</span>no_cuda <span class=\"token keyword\">and</span> torch<span class=\"token punctuation\">.</span>cuda<span class=\"token punctuation\">.</span>is_available<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    torch<span class=\"token punctuation\">.</span>manual_seed<span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">.</span>seed<span class=\"token punctuation\">)</span>\n\n    device <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>device<span class=\"token punctuation\">(</span><span class=\"token string\">\"cuda\"</span> <span class=\"token keyword\">if</span> use_cuda <span class=\"token keyword\">else</span> <span class=\"token string\">\"cpu\"</span><span class=\"token punctuation\">)</span>\n\n    train_kwargs <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"batch_size\"</span><span class=\"token punctuation\">:</span> args<span class=\"token punctuation\">.</span>batch_size<span class=\"token punctuation\">}</span>\n    test_kwargs <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"batch_size\"</span><span class=\"token punctuation\">:</span> args<span class=\"token punctuation\">.</span>test_batch_size<span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span> use_cuda<span class=\"token punctuation\">:</span>\n        cuda_kwargs <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"num_workers\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"pin_memory\"</span><span class=\"token punctuation\">:</span> <span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"shuffle\"</span><span class=\"token punctuation\">:</span> <span class=\"token boolean\">True</span><span class=\"token punctuation\">}</span>\n        train_kwargs<span class=\"token punctuation\">.</span>update<span class=\"token punctuation\">(</span>cuda_kwargs<span class=\"token punctuation\">)</span>\n        test_kwargs<span class=\"token punctuation\">.</span>update<span class=\"token punctuation\">(</span>cuda_kwargs<span class=\"token punctuation\">)</span>\n\n    transform <span class=\"token operator\">=</span> transforms<span class=\"token punctuation\">.</span>Compose<span class=\"token punctuation\">(</span>\n        <span class=\"token punctuation\">[</span>transforms<span class=\"token punctuation\">.</span>ToTensor<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> transforms<span class=\"token punctuation\">.</span>Normalize<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">0.1307</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.3081</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">)</span>\n    dataset1 <span class=\"token operator\">=</span> datasets<span class=\"token punctuation\">.</span>MNIST<span class=\"token punctuation\">(</span><span class=\"token string\">\"../data\"</span><span class=\"token punctuation\">,</span> train<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> download<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> transform<span class=\"token operator\">=</span>transform<span class=\"token punctuation\">)</span>\n    dataset2 <span class=\"token operator\">=</span> datasets<span class=\"token punctuation\">.</span>MNIST<span class=\"token punctuation\">(</span><span class=\"token string\">\"../data\"</span><span class=\"token punctuation\">,</span> train<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span> transform<span class=\"token operator\">=</span>transform<span class=\"token punctuation\">)</span>\n    train_loader <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>DataLoader<span class=\"token punctuation\">(</span>dataset1<span class=\"token punctuation\">,</span> <span class=\"token operator\">**</span>train_kwargs<span class=\"token punctuation\">)</span>\n    test_loader <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>DataLoader<span class=\"token punctuation\">(</span>dataset2<span class=\"token punctuation\">,</span> <span class=\"token operator\">**</span>test_kwargs<span class=\"token punctuation\">)</span>\n\n    model <span class=\"token operator\">=</span> Net<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">(</span>device<span class=\"token punctuation\">)</span>\n    optimizer <span class=\"token operator\">=</span> optim<span class=\"token punctuation\">.</span>Adadelta<span class=\"token punctuation\">(</span>model<span class=\"token punctuation\">.</span>parameters<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> lr<span class=\"token operator\">=</span>args<span class=\"token punctuation\">.</span>lr<span class=\"token punctuation\">)</span>\n\n    scheduler <span class=\"token operator\">=</span> StepLR<span class=\"token punctuation\">(</span>optimizer<span class=\"token punctuation\">,</span> step_size<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> gamma<span class=\"token operator\">=</span>args<span class=\"token punctuation\">.</span>gamma<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">for</span> epoch <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">.</span>epochs <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        train<span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">,</span> model<span class=\"token punctuation\">,</span> device<span class=\"token punctuation\">,</span> train_loader<span class=\"token punctuation\">,</span> optimizer<span class=\"token punctuation\">,</span> epoch<span class=\"token punctuation\">)</span>\n        test<span class=\"token punctuation\">(</span>model<span class=\"token punctuation\">,</span> device<span class=\"token punctuation\">,</span> test_loader<span class=\"token punctuation\">)</span>\n        scheduler<span class=\"token punctuation\">.</span>step<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">if</span> args<span class=\"token punctuation\">.</span>save_model<span class=\"token punctuation\">:</span>\n        torch<span class=\"token punctuation\">.</span>save<span class=\"token punctuation\">(</span>model<span class=\"token punctuation\">.</span>state_dict<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"models/mnist.pt\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">if</span> __name__ <span class=\"token operator\">==</span> <span class=\"token string\">\"__main__\"</span><span class=\"token punctuation\">:</span>\n    main<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">python train.py --epochs <span class=\"token number\">1</span> --save-model</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p><strong>✓ Load Model &#x26; Prediction</strong></p>\n<ul>\n<li>\n<p><code class=\"language-text\">test.py</code></p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-python line-numbers\"><code class=\"language-python\"><span class=\"token keyword\">import</span> torch\n<span class=\"token keyword\">from</span> model <span class=\"token keyword\">import</span> Net\n<span class=\"token keyword\">import</span> argparse\n<span class=\"token keyword\">from</span> PIL <span class=\"token keyword\">import</span> Image\n<span class=\"token keyword\">import</span> numpy <span class=\"token keyword\">as</span> np\n<span class=\"token keyword\">from</span> torchvision <span class=\"token keyword\">import</span> transforms\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">load_model</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    model <span class=\"token operator\">=</span> Net<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    PATH <span class=\"token operator\">=</span> <span class=\"token string\">\"./models/mnist.pt\"</span>\n    model<span class=\"token punctuation\">.</span>load_state_dict<span class=\"token punctuation\">(</span>torch<span class=\"token punctuation\">.</span>load<span class=\"token punctuation\">(</span>PATH<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> model\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">preprocess</span><span class=\"token punctuation\">(</span>image_path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    transform <span class=\"token operator\">=</span> transforms<span class=\"token punctuation\">.</span>Compose<span class=\"token punctuation\">(</span>\n        <span class=\"token punctuation\">[</span>transforms<span class=\"token punctuation\">.</span>ToTensor<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> transforms<span class=\"token punctuation\">.</span>Normalize<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">0.1307</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.3081</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">)</span>\n    image <span class=\"token operator\">=</span> Image<span class=\"token punctuation\">.</span><span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span>image_path<span class=\"token punctuation\">)</span>\n    image <span class=\"token operator\">=</span> transform<span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> image\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">predict</span><span class=\"token punctuation\">(</span>model<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    x <span class=\"token operator\">=</span> x<span class=\"token punctuation\">.</span>unsqueeze<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n    output <span class=\"token operator\">=</span> model<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span>\n    pred <span class=\"token operator\">=</span> output<span class=\"token punctuation\">.</span>argmax<span class=\"token punctuation\">(</span>dim<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> keepdim<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">return</span> pred<span class=\"token punctuation\">.</span>item<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    parser <span class=\"token operator\">=</span> argparse<span class=\"token punctuation\">.</span>ArgumentParser<span class=\"token punctuation\">(</span>description<span class=\"token operator\">=</span><span class=\"token string\">\"PyTorch MNIST Test Example\"</span><span class=\"token punctuation\">)</span>\n\n    parser<span class=\"token punctuation\">.</span>add_argument<span class=\"token punctuation\">(</span>\n        <span class=\"token string\">\"--image_path\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">type</span><span class=\"token operator\">=</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">help</span><span class=\"token operator\">=</span><span class=\"token string\">\"input test image path\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span>\n    args <span class=\"token operator\">=</span> parser<span class=\"token punctuation\">.</span>parse_args<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    model <span class=\"token operator\">=</span> load_model<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    \n    image <span class=\"token operator\">=</span> preprocess<span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">.</span>image_path<span class=\"token punctuation\">)</span>\n    \n    result <span class=\"token operator\">=</span> predict<span class=\"token punctuation\">(</span>model<span class=\"token punctuation\">,</span> image<span class=\"token punctuation\">)</span>\n    \n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"result: \"</span><span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">if</span> __name__ <span class=\"token operator\">==</span> <span class=\"token string\">\"__main__\"</span><span class=\"token punctuation\">:</span>\n    main<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-python line-numbers\"><code class=\"language-python\">python test<span class=\"token punctuation\">.</span>py <span class=\"token operator\">-</span><span class=\"token operator\">-</span>image_path <span class=\"token string\">'images/img_0.jpg'</span>\n\n<span class=\"token comment\"># Return:</span>\n<span class=\"token comment\"># result:  1</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span></span></pre></div>\n<p><strong>✓ Flask Project Complete</strong></p>\n<ul>\n<li>\n<p><code class=\"language-text\">app.py</code></p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-python line-numbers\"><code class=\"language-python\"><span class=\"token keyword\">import</span> torch\n<span class=\"token keyword\">from</span> flask <span class=\"token keyword\">import</span> Flask<span class=\"token punctuation\">,</span> request\n<span class=\"token keyword\">from</span> model <span class=\"token keyword\">import</span> Net\n<span class=\"token keyword\">import</span> argparse\n<span class=\"token keyword\">from</span> torchvision <span class=\"token keyword\">import</span> transforms\n<span class=\"token keyword\">from</span> PIL <span class=\"token keyword\">import</span> Image\n<span class=\"token keyword\">from</span> test <span class=\"token keyword\">import</span> preprocess\n\napp <span class=\"token operator\">=</span> Flask<span class=\"token punctuation\">(</span>__name__<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">load_model</span><span class=\"token punctuation\">(</span>model_path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    model <span class=\"token operator\">=</span> Net<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    model<span class=\"token punctuation\">.</span>load_state_dict<span class=\"token punctuation\">(</span>torch<span class=\"token punctuation\">.</span>load<span class=\"token punctuation\">(</span>model_path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> model\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">preprocessing</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"Preprocessing Function\n\n    Input:\n        Flask Class 'FileStorage'\n    Output:\n        Image\n    \"\"\"</span>\n    transform <span class=\"token operator\">=</span> transforms<span class=\"token punctuation\">.</span>Compose<span class=\"token punctuation\">(</span>\n        <span class=\"token punctuation\">[</span>transforms<span class=\"token punctuation\">.</span>ToTensor<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> transforms<span class=\"token punctuation\">.</span>Normalize<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">0.1307</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.3081</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">)</span>\n    image <span class=\"token operator\">=</span> Image<span class=\"token punctuation\">.</span><span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span>\n    image <span class=\"token operator\">=</span> transform<span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> image\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">predict</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"Predict Function\n\n    Input:\n        Image\n    Output:\n        value\n    \"\"\"</span>\n\n    x <span class=\"token operator\">=</span> x<span class=\"token punctuation\">.</span>unsqueeze<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n    output <span class=\"token operator\">=</span> model<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span>\n    pred <span class=\"token operator\">=</span> output<span class=\"token punctuation\">.</span>argmax<span class=\"token punctuation\">(</span>dim<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> keepdim<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">return</span> pred<span class=\"token punctuation\">.</span>item<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>route</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">root_route</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"error\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"use POST /prediction instead of root route\"</span><span class=\"token punctuation\">}</span>\n\n<span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>route</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/prediction\"</span><span class=\"token punctuation\">,</span> methods<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"POST\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">prediction_route</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"Prediction Router\n\n    Input:\n        formData from Flask\n    Output:\n        Json: (\"class_name\": value)\n        example:\n             {\"class_name\": 1}\n    \"\"\"</span>\n\n    data <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>files<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">\"file\"</span><span class=\"token punctuation\">)</span>\n\n    image <span class=\"token operator\">=</span> preprocess<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span>\n    result <span class=\"token operator\">=</span> predict<span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"result: \"</span><span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"class_name\"</span><span class=\"token punctuation\">:</span> result<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    parser <span class=\"token operator\">=</span> argparse<span class=\"token punctuation\">.</span>ArgumentParser<span class=\"token punctuation\">(</span>description<span class=\"token operator\">=</span><span class=\"token string\">\"Flask App\"</span><span class=\"token punctuation\">)</span>\n\n    parser<span class=\"token punctuation\">.</span>add_argument<span class=\"token punctuation\">(</span>\n        <span class=\"token string\">\"--model_path\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">type</span><span class=\"token operator\">=</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">,</span>\n        <span class=\"token builtin\">help</span><span class=\"token operator\">=</span><span class=\"token string\">\"input model path\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span>\n    args <span class=\"token operator\">=</span> parser<span class=\"token punctuation\">.</span>parse_args<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">global</span> model\n    model <span class=\"token operator\">=</span> load_model<span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">.</span>model_path<span class=\"token punctuation\">)</span>\n\n    app<span class=\"token punctuation\">.</span>run<span class=\"token punctuation\">(</span>debug<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">if</span> __name__ <span class=\"token operator\">==</span> <span class=\"token string\">\"__main__\"</span><span class=\"token punctuation\">:</span>\n    main<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">python app.py --model_path models/mnist.pt</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>test</p>\n<ul>\n<li>\n<p>img_1.jpg</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 28px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/26c0a28d9d53b9bf70d37c1fb8b153fa/dcb9a/img_1.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAQDBv/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAefonuIQNAzB/8QAGxAAAQQDAAAAAAAAAAAAAAAAAQACAxAEEjH/2gAIAQEAAQUCT49Y6yeUXEhf/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAwEBPwEf/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAgEBPwEf/8QAGxAAAQQDAAAAAAAAAAAAAAAAAQIDEDEAQWP/2gAIAQEABj8CxtW1S0OYkAmqj//EABsQAQACAgMAAAAAAAAAAAAAAAEQESFhAFGh/9oACAEBAAE/IeFeNK11mVpnpK+Ex0j/2gAMAwEAAgADAAAAEEAIAP/EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8QH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8QH//EAB4QAQACAgEFAAAAAAAAAAAAAAERMQAQIUFRYYGh/9oACAEBAAE/EC8kbK4cAge70ZwYBwjvJfui8LsyD0XB41//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"img_1.jpg\"\n        title=\"img_1.jpg\"\n        src=\"/static/26c0a28d9d53b9bf70d37c1fb8b153fa/dcb9a/img_1.jpg\"\n        srcset=\"/static/26c0a28d9d53b9bf70d37c1fb8b153fa/dcb9a/img_1.jpg 28w\"\n        sizes=\"(max-width: 28px) 100vw, 28px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\"><span class=\"token function\">curl</span> -F <span class=\"token string\">\"file=@images/img_1.jpg\"</span> localhost:5000/prediction\n\n<span class=\"token comment\"># Return:</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"class_name\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>","tableOfContents":"<ul>\n<li>\n<p><a href=\"/category/blog/mnist-classification/2-backend/#mnist-%ED%95%99%EC%8A%B5-%EB%B0%8F-%EB%AA%A8%EB%8D%B8-%EC%84%9C%EB%B9%99\">MNIST 학습 및 모델 서빙</a></p>\n<ul>\n<li>\n<ul>\n<li><a href=\"/category/blog/mnist-classification/2-backend/#-stack\">📚 Stack</a></li>\n</ul>\n</li>\n<li><a href=\"/category/blog/mnist-classification/2-backend/#logs\">Logs</a></li>\n</ul>\n</li>\n</ul>","frontmatter":{"title":"[MNIST Classification - 2] MNIST 학습 및 모델 서빙","description":"","date":"2021.10.09","emoji":"📚","category":"blog"}}},"pageContext":{"slug":"/category/blog/mnist-classification/2-backend/","relatedPosts":[{"node":{"fields":{"slug":"/category/blog/interview/"},"frontmatter":{"title":"[면접준비] minimum 질문&답변","date":"2021.11.22","emoji":"❓","category":"blog"}}},{"node":{"fields":{"slug":"/category/blog/hackerrank_certification/"},"frontmatter":{"title":"해커랭크 인증서 발급 후기","date":"2021.11.19","emoji":"📚","category":"blog"}}},{"node":{"fields":{"slug":"/category/blog/m1-tensorflow/"},"frontmatter":{"title":"[Tensorflow] M1에서 Tensorflow GPU 사용하기 (Monterey)","date":"2021.11.13","emoji":"💪","category":"blog"}}},{"node":{"fields":{"slug":"/category/blog/effective-python/"},"frontmatter":{"title":"[책] 파이썬 코딩의 기술","date":"2021.11.02","emoji":"📚","category":"blog"}}},{"node":{"fields":{"slug":"/category/blog/mlops/simple_model_deploy_mnist/"},"frontmatter":{"title":"[MLOps] Vertex AI에서 모델 배포하기 (MNIST)","date":"2021.11.01","emoji":"🏃","category":"blog"}}}]}}}